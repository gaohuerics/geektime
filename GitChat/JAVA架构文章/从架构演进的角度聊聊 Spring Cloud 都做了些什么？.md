## 内容提要

内容提要：

- 如果每个微服务都有自己独立的数据库，那么管理系统做数据统计展示时，工作量是不是就需要连多个库做合并，这样工作量应该会复杂很多。如果有两个微服务，一个需要生成数据写入数据库，另一个需要从数据库来读这些数据使用，这种情况一般怎么做好？
- 做代码实现一个小需求，一check in到自动化测试的Master分支就自动测试和部署(在有docker和k8部署平台的情况下)，这个是不是和微服务关系比较大？除了说做自动化接口、脚本测试外，如何落地？
- 单体应用到微服务的重构、业务拆分、技术栈更新，Spring Cloud和Dubbo相比有什么优势？中小型团队，技术储备一般，哪种方式更有利于落地和降低计划实施风险？
- 可以介绍下Spring的作用吗？如果没有Spring，还有类似的东西吗？区别是什么？
- 对于Spring Cloud搭建商城的微服务有什么建议？
- 你是第三方支付的，我也是第三方支付的，我们目前的服务主要用的是Dubbo，如果想往Spring Cloud转，希望能给些建议，以及遇到过哪些坑？
- Spring Cloud的体系很大，应该怎样学习？有什么学习路线，方式推荐吗？
- Spring Boot和Spring Cloud的关系？Spring Boot构建的单一服务，如果进一步扩展，需要考虑微服务？
- 请问事务处理这一块，尤其是订单场景的事务处理，有什么好的实践或者建议吗？
- 关于服务拆分的颗粒度这块，依照哪些维度拆分比较好？

------

**问：如果每个微服务都有自己独立的数据库，那么管理系统做数据统计展示时，工作量是不是就需要连多个库做合并，这样工作量应该会复杂很多。如果有两个微服务，一个需要生成数据写入数据库，另一个需要从数据库来读这些数据使用，这种情况一般怎么做好？**

**答：**每个微服务都有自己独立的数据库，导致后台关联查询业务实现起来比较复杂，是大家普遍都会遇到的一个问题。我们也算是踩过一段时间的坑。主要有三个解决方案。

1. 严格按照微服务的划分来做，微服务相互独立，各微服务数据库也独立，后台需要展示数据时，调用各微服务的接口来获取对应的数据，再进行数据处理后展示出来，这是标准的用法，也是最麻烦的用法。
2. 将业务高度相关的表放到一个库中，将业务关系不是很紧密的表严格按照微服务模式来拆分，这样既可以使用微服务，也避免了数据库分散导致后台系统统计功能难以实现，是一个折中的方案。
3. 数据库严格按照微服务的要求来切分，以满足业务高并发，实时或者准实时将各微服务数据库数据同步到NoSQL数据库中，在同步的过程中进行数据清洗，用来满足后台业务系统的使用，推荐使用MongoDB、HBase等。

三种方案在不同的公司我都使用过，第一种方案适合业务较为简单的小公司；第二种方案，适合在原有系统之上，慢慢演化为微服务架构的公司；第三种适合大型高并发的互联网公司。

一般一个微服务享用这个数据库的管理权，其他服务如果需要写入或者读取此服务内的数据，都应该通过此服务的接口来调用。

------

**问：做代码实现一个小需求，一check in到自动化测试的Master分支就自动测试和部署(在有docker和k8部署平台的情况下)，这个是不是和微服务关系比较大？除了说做自动化接口、脚本测试外，如何落地？**

**答：**首先我们并没有使用docker和k8s相关的技术，自动化部署工具使用的是jenkins，正常的发布流程是这样的：开发人员实现一个小需求，然后提交到Master分支，然后运维人员手动点击发布将代码部署到生产环境。

另外，提交代码后自动测试并部署到生产环境是可以实现的，方案是这样的：在提交代码的时候可以触发版本库的Refresh，Refresh触发一个提前编写好的脚本去调用jenkins部署的接口。jenkins打包依赖于maven，maven来做自动化测试，只有junit测试成功才会进行打包。打包成功后jenkins会自动部署到目标服务器，以达到提交代码、自动化测试、自动部署的目的。

------

**问：单体应用到微服务的重构、业务拆分、技术栈更新，Spring Cloud和Dubbo相比有什么优势？中小型团队，技术储备一般，哪种方式更有利于落地和降低计划实施风险？**

**答：** Spring Cloud和dubbo相比有什么优势：dubbo框架只是专注于服务之间的治理，而Spring Cloud几乎考虑了服务治理的方方面面；dubbo已经停止更新很多年，Spring Cloud正在迅速的发展。一个比喻：dubbo是过去时，Spring Cloud的是将来时。小公司，技术储备一般建议选择使用Spring Cloud，因为Spring Cloud已经帮我们集成了很多的组件。如果使用dubbo需要我们自己去集成各种开源的解决方案，难度有所增加。建议先学习Spring Boot，部分项目使用，熟悉Spring Boot之后再引进Spring Cloud，项目改造也是分批进行演化。

------

**问：可以介绍下Spring的作用吗？如果没有Spring，还有类似的东西吗？区别是什么？**

**答：** Spring是Java届的第一框架，也是Spring Boot/Cloud的根基。Spring Boot是 Spring的一套快速配置脚手架，Spring Boot依赖Spring来实现。Spring Cloud又依赖于Spring Boot来实现。所以他们是这样的关系：Spring -> Spring Boot > Spring Cloud。Spring现在已经非常稳定丰富，没有类似的可以取代。

------

**问：对于Spring Cloud搭建商城的微服务有什么建议？**

**答：** Spring Cloud只是一门技术，不限定具体的使用场景。个人理解，搭建商城最关键的是根据商城的业务和规模做好服务边界划分。根据团队掌握Spring Boot/Cloud的情况，来推进项目实施进展。

------

**问：你是第三方支付的，我也是第三方支付的，我们目前的服务主要用的是Dubbo，如果想往Spring Cloud转，希望能给些建议，以及遇到过哪些坑？**

**答：**如果想往Spring Cloud转，分三步：第一，先学习Spring Boot技术，在部分项目上实践；第二，再学习Spring Cloud相关技术，部分服务进行切换；第三，根据组内成员的情况来控制演化的节奏。

在切换之前需要对服务进行分类，有四种：基础服务、业务服务、组合服务、前置服务。不同服务迁移的优先级不同。优先在基础服务或者新上线的项目中使用。

建议尽量不要使用Jsp，内嵌Tomcat部署Jsp项目会偶现龟速访问的情况。页面开发推荐使用Thymeleaf，使用服务编排可以降低项目之间的相互依赖度。Spring Cloud生态的技术有很多，并不是每一种技术方案都需要用上，适合自己的才是最好的。

------

**问：Spring Cloud的体系很大，应该怎样学习？有什么学习路线，方式推荐？**

**答：**刚才提到了学习Spring Cloud的前提是掌握Spring Boot，因此第一个建议是先学习 Spring Boot。刚开始学习Spring Cloud的时候，建议只关注服务的注册和发现。当使用的深度慢慢增加，后面再考虑熔断、监控其他技术。实践是最好的学习方式，建议先使用Spring Boot/Cloud搭建几个小项目或者模仿去做一些小例子。

------

**问：Spring Boot和Spring Cloud的关系？Spring Boot构建的单一服务，如果进一步扩展，需要考虑微服务？**

**答：** Spring Boot和Spring Cloud的关系前面已经提到：Spring Cloud基于Spring Boot来实现的云应用开发工具。另外，Spring Boot专注于快速、方便集成的单个个体，Spring Cloud是关注全局的服务治理框架。Spring Boot构建的单一服务，当单个服务越来越多，相互的调用关系也会成指数增长，因此在演进到一定程度需要Spring Cloud进行服务治理。

------

**问：请问事务处理这一块，尤其是订单场景的事务处理，有什么好的实践或者建议吗？**

**答：**分布式事务Spring Boot可以集成Aatomikos来解决，但是我个人不建议在微服务架构中使用。使用分布式事务会降低服务整体的响应速度，建议采取消息补偿机制来做最终一致性检查。

------

**问：关于服务拆分的颗粒度这块，请问依照哪些维度拆分比较好？**

**答：**服务拆分有以下几个原则和大家分享。横向拆分：按照不同的业务领域进行拆分，例如订单、营销、风控、积分资源等，形成独立的业务领域微服务集群。纵向拆分：把一个业务功能里的不同模块或者组件进行拆分。例如把公共组件拆分成独立的原子服务，下沉到底层，形成相对独立的原子服务层。这样一纵一横，就可以实现业务的服务化拆分。服务拆分的大与小是相对的。比如在初期，我们把交易拆分为一个微服务，但是随着业务量的增大，可能一个交易系统已经慢慢变得很大，并且并发流量也不小，为了支撑更多的交易量，我会把交易系统，拆分为订单服务、投标服务、转让服务等。所以服务的拆分是根据业务的规模动态调整的。



## 文章实录

Spring Cloud作为一套微服务治理的框架，几乎考虑到了微服务治理的方方面面，之前也写过一些关于Spring Cloud文章，主要偏重各组件的使用，本次分享主要解答这两个问题：Spring Cloud在微服务的架构中都做了哪些事情？Spring Cloud提供的这些功能对微服务的架构提供了怎样的便利？

我们先来简单回顾一下，我们以往互联网架构的发展情况：

### 传统架构发展史

#### 单体架构

单体架构在小微企业比较常见，典型代表就是一个应用、一个数据库、一个web容器就可以跑起来，比如我们开发的开源软件[云收藏](https://github.com/cloudfavorites/favorites-web)，就是标准的单体架构。

在两种情况下可能会选择单体架构：一是在企业发展的初期，为了保证快速上线，采用此种方案较为简单灵活；二是传统企业中垂直度较高，访问压力较小的业务。在这种模式下对技术要求较低，方便各层次开发人员接手，也能满足客户需求。

下面是单体架构的架构图：

![img](http://www.ityouknow.com/assets/images/2017/chat/single_structure.jpg)

在单体架构中，技术选型非常灵活，优先满足快速上线的要求，也便于快速跟进市场。

#### 垂直架构

在单体架构发展一段时间后，公司的业务模式得到了认可，交易量也慢慢的大起来，这时候有些企业为了应对更大的流量，就会对原有的业务进行拆分，比如说：后台系统、前端系统、交易系统等。

在这一阶段往往会将系统分为不同的层级，每个层级有对应的职责，UI层负责和用户进行交互、业务逻辑层负责具体的业务功能、数据库层负责和上层进行数据交换和存储。

下面是垂直架构的架构图：

![img](http://www.ityouknow.com/assets/images/2017/chat/vertical__structure.jpg)

在这个阶段SSH（struts+spring+hibernate）是项目的关键技术，Struts负责web层逻辑控制、Spring负责业务层管理Bean、Hibernate负责数据库操作进行封装，持久化数据。

#### 服务化架构

如果公司进一步的做大，垂直子系统会变的越来越多，系统和系统之间的调用关系呈指数上升的趋势。在这样的背景下，很多公司都会考虑服务的SOA化。SOA代表面向服务的架构，将应用程序根据不同的职责划分为不同的模块，不同的模块直接通过特定的协议和接口进行交互。这样使整个系统切分成很多单个组件服务来完成请求，当流量过大时通过水平扩展相应的组件来支撑，所有的组件通过交互来满足整体的业务需求。

SOA服务化的优点是，它可以根据需求通过网络对松散耦合的粗粒度应用组件进行分布式部署、组合和使用。服务层是SOA的基础，可以直接被应用调用，从而有效控制系统中与软件代理交互的人为依赖性。

服务化架构是一套松耦合的架构，服务的拆分原则是服务内部高内聚，服务之间低耦合。

下面是服务化架构图：

![img](http://www.ityouknow.com/assets/images/2017/chat/soa__structure.jpg)

在这个阶段可以使用WebService或者dubbo来服务治理。

### SOA和微服务架构

#### SOA和微服务的区别

其实服务化架构已经可以解决大部分企业的需求了，那么我们为什么要研究微服务呢？先说说它们的区别；

- 微服务架构强调业务系统需要彻底的组件化和服务化，一个组件就是一个产品，可以独立对外提供服务
- 微服务不再强调传统SOA架构里面比较重的ESB企业服务总线
- 微服务强调每个微服务都有自己独立的运行空间，包括数据库资源。
- 微服务架构本身来源于互联网的思路，因此组件对外发布的服务强调了采用HTTP Rest API的方式来进行
- 微服务的切分粒度会更小

> 总结:微服务架构是 SOA 架构思想的一种扩展，更加强调服务个体的独立性、拆分粒度更小。

#### 为什么考虑Spring Cloud

- Spring Cloud来源于Spring，质量、稳定性、持续性都可以得到保证
- Spirng Cloud天然支持Spring Boot，更加便于业务落地。
- Spring Cloud发展非常的快，从16年开始接触的时候相关组件版本为1.x，到现在将要发布2.x系列
- Spring Cloud是Java领域最适合做微服务的框架。
- 相比于其它框架,Spring Cloud对微服务周边环境的支持力度最大。
- 对于中小企业来讲，使用门槛较低。

> Spring Cloud　是微服务架构的最佳落地方案

#### 它的特性

以下为Spring Cloud的核心特性：

- 分布式/版本化配置
- 服务注册和发现
- 路由
- 服务和服务之间的调用
- 负载均衡
- 断路器
- 分布式消息传递

这些特性都是由不同的组件来完成，在架构的演进过程中扮演着重要的角色，接下来我们一起看看。

### 微服务架构

Spring Cloud解决的第一个问题就是：服务与服务之间的解耦。很多公司在业务高速发展的时候，服务组件也会相应的不断增加。服务和服务之间有着复杂的相互调用关系，经常有服务A调用服务B，服务B调用服务C和服务D ...，随着服务化组件的不断增多，服务之间的调用关系成指数级别的增长，极端情况下就如下图所示：

![img](http://www.ityouknow.com/assets/images/2017/architecture/calling_relation.png)

这样最容易导致的情况就是牵一发而动全身。经常出现由于某个服务更新而没有通知到其它服务，导致上线后惨案频发。这时候就应该进行服务治理，将服务之间的直接依赖转化为服务对服务中心的依赖。Spring Cloud 核心组件Eureka就是解决这类问题。

#### Eureka

Eureka是Netflix开源的一款提供服务注册和发现的产品，它提供了完整的Service Registry和Service Discovery实现。也是Spring Cloud体系中最重要最核心的组件之一。

用大白话讲，Eureka就是一个服务中心，将所有的可以提供的服务都注册到它这里来管理，其它各调用者需要的时候去注册中心获取，然后再进行调用，避免了服务之间的直接调用，方便后续的水平扩展、故障转移等。如下图：

![img](http://www.ityouknow.com/assets/images/2017/architecture/eureka.jpg)

当然服务中心这么重要的组件一但挂掉将会影响全部服务，因此需要搭建Eureka集群来保持高可用性，生产中建议最少两台。随着系统的流量不断增加，需要根据情况来扩展某个服务，Eureka内部已经提供均衡负载的功能，只需要增加相应的服务端实例既可。那么在系统的运行期间某个实例挂了怎么办？Eureka内容有一个心跳检测机制，如果某个实例在规定的时间内没有进行通讯则会自动被剔除掉，避免了某个实例挂掉而影响服务。

因此使用了Eureka就自动具有了注册中心、负载均衡、故障转移的功能。

#### Hystrix

在微服务架构中通常会有多个服务层调用，基础服务的故障可能会导致级联故障，进而造成整个系统不可用的情况，这种现象被称为服务雪崩效应。服务雪崩效应是一种因“服务提供者”的不可用导致“服务消费者”的不可用,并将不可用逐渐放大的过程。

如下图所示：A作为服务提供者，B为A的服务消费者，C和D是B的服务消费者。A不可用引起了B的不可用，并将不可用像滚雪球一样放大到C和D时，雪崩效应就形成了。

![img](http://www.ityouknow.com/assets/images/2017/springcloud/hystrix-1.png)

在这种情况下就需要整个服务机构具有故障隔离的功能，避免某一个服务挂掉影响全局。在Spring Cloud 中Hystrix组件就扮演这个角色。

Hystrix会在某个服务连续调用N次不响应的情况下，立即通知调用端调用失败，避免调用端持续等待而影响了整体服务。Hystrix间隔时间会再次检查此服务，如果服务恢复将继续提供服务。

#### Hystrix Dashboard和Turbine

当熔断发生的时候需要迅速的响应来解决问题，避免故障进一步扩散，那么对熔断的监控就变得非常重要。熔断的监控现在有两款工具：Hystrix-dashboard和Turbine

Hystrix-dashboard是一款针对Hystrix进行实时监控的工具，通过Hystrix Dashboard我们可以直观地看到各Hystrix Command的请求响应时间, 请求成功率等数据。但是只使用Hystrix Dashboard的话, 你只能看到单个应用内的服务信息, 这明显不够. 我们需要一个工具能让我们汇总系统内多个服务的数据并显示到Hystrix Dashboard上, 这个工具就是Turbine. 监控的效果图如下：

![img](http://www.ityouknow.com/assets/images/2017/springcloud/turbine-02.jpg)

#### 配置中心

随着微服务不断的增多，每个微服务都有自己对应的配置文件。在研发过程中有测试环境、UAT环境、生产环境，因此每个微服务又对应至少三个不同环境的配置文件。这么多的配置文件，如果需要修改某个公共服务的配置信息，如：缓存、数据库等，难免会产生混乱，这个时候就需要引入Spring Cloud另外一个组件：Spring Cloud Config。

**Spring Cloud Config**

Spring Cloud Config是一个解决分布式系统的配置管理方案。它包含了Client和Server两个部分，Server提供配置文件的存储、以接口的形式将配置文件的内容提供出去，Client通过接口获取数据、并依据此数据初始化自己的应用。

其实就是Server端将所有的配置文件服务化，需要配置文件的服务实例去Config Server获取对应的数据。将所有的配置文件统一整理，避免了配置文件碎片化。

如果服务运行期间改变配置文件，服务是不会得到最新的配置信息，需要解决这个问题就需要引入Refresh。可以在服务的运行期间重新加载配置文件。

当所有的配置文件都存储在配置中心的时候，配置中心就成为了一个非常重要的组件。如果配置中心出现问题将会导致灾难性的后果，因此在生产中建议对配置中心做集群，来支持配置中心高可用性。

**Spring Cloud Bus**

上面的Refresh方案虽然可以解决单个微服务运行期间重载配置信息的问题，但是在真正的实践生产中，可能会有N多的服务需要更新配置，如果每次依靠手动Refresh将是一个巨大的工作量，这时候Spring Cloud提出了另外一个解决方案：Spring Cloud Bus

Spring Cloud Bus通过轻量消息代理连接各个分布的节点。这会用在广播状态的变化（例如配置变化）或者其它的消息指令中。Spring Cloud Bus的一个核心思想是通过分布式的启动器对Spring Boot应用进行扩展，也可以用来建立一个或多个应用之间的通信频道。目前唯一实现的方式是用AMQP消息代理作为通道。

Spring Cloud Bus是轻量级的通讯组件，也可以用在其它类似的场景中。有了Spring Cloud Bus之后，当我们改变配置文件提交到版本库中时，会自动的触发对应实例的Refresh，具体的工作流程如下：

![img](http://www.ityouknow.com/assets/images/2017/springcloud/configbus2.jpg)

#### 服务网关

在微服务架构模式下，后端服务的实例数一般是动态的，对于客户端而言很难发现动态改变的服务实例的访问地址信息。因此在基于微服务的项目中为了简化前端的调用逻辑，通常会引入API Gateway作为轻量级网关，同时API Gateway中也会实现相关的认证逻辑从而简化内部服务之间相互调用的复杂度。

![img](http://www.ityouknow.com/assets/images/2017/springcloud/api_gateway.png)

Spring Cloud体系中支持API Gateway落地的技术就是Zuul。Spring Cloud Zuul路由是微服务架构中不可或缺的一部分，提供动态路由，监控，弹性，安全等的边缘服务。Zuul是Netflix出品的一个基于JVM路由和服务端的负载均衡器。

它的具体作用就是服务转发，接收并转发所有内外部的客户端调用。使用Zuul可以作为资源的统一访问入口，同时也可以在网关做一些权限校验等类似的功能。

#### 链路跟踪

随着服务的越来越多，对调用链的分析会越来越复杂，如服务之间的调用关系、某个请求对应的调用链、调用之间消费的时间等，对这些信息进行监控就成为一个问题。在实际的使用中我们需要监控服务和服务之间通讯的各项指标，这些数据将是我们改进系统架构的主要依据。因此分布式的链路跟踪就变的非常重要，Spring Cloud也给出了具体的解决方案：Spring Cloud Sleuth和Zipkin

![img](http://www.ityouknow.com/assets/images/2017/architecture/dyl.png)

Spring Cloud Sleuth为服务之间调用提供链路追踪。通过Sleuth可以很清楚的了解到一个服务请求经过了哪些服务，每个服务处理花费了多长时间。从而让我们可以很方便的理清各微服务间的调用关系。

Zipkin是Twitter的一个开源项目，允许开发者收集 Twitter 各个服务上的监控数据，并提供查询接口

#### 总结

我们从整体上来看一下Spring Cloud各个组件如何来配套使用：



![img](http://www.ityouknow.com/assets/images/2017/chat/spring_cloud_structure.png)

从上图可以看出Spring Cloud各个组件相互配合，合作支持了一套完整的微服务架构。

- 其中Eureka负责服务的注册与发现，很好将各服务连接起来
- Hystrix 负责监控服务之间的调用情况，连续多次失败进行熔断保护。
- Hystrix dashboard,Turbine 负责监控 Hystrix的熔断情况，并给予图形化的展示
- Spring Cloud Config 提供了统一的配置中心服务
- 当配置文件发生变化的时候，Spring Cloud Bus 负责通知各服务去获取最新的配置信息
- 所有对外的请求和服务，我们都通过Zuul来进行转发，起到API网关的作用
- 最后我们使用Sleuth+Zipkin将所有的请求数据记录下来，方便我们进行后续分析

Spring Cloud从设计之初就考虑了绝大多数互联网公司架构演化所需的功能，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等。这些功能都是以插拔的形式提供出来，方便我们系统架构演进的过程中，可以合理的选择需要的组件进行集成，从而在架构演进的过程中会更加平滑、顺利。

微服务架构是一种趋势，Spring Cloud提供了标准化的、全站式的技术方案，意义可能会堪比当前Servlet规范的诞生，有效推进服务端软件系统技术水平的进步。